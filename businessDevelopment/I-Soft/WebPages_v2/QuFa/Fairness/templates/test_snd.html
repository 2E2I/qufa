<!DOCTYPE html>
<html lang="kr">

<head>
    <title>Send Test</title>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" />
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js"></script>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/qufa.css' %}">
</head>

<body>
    <div class="container" style='width:100%;'>

        <div class='row' style='height:90px;padding-top:40px;'>
            <div class='col-4'></div>
            <div class='col-4'>
                <h4 class="font-weight-bold text-center text-primary">Upload Test (from local)</h4>
            </div>
            <div class='col-4'></div>
        </div>
        <div class='row'>
            <div class='col-10'>
                <span class='btn btn-sm btn-success fileinput-button loading'>
                <span id='idSpanXls0'><i class='fa fa-table'></i> Set Train File</span>
                <input type='file' id="fileupload" accept="text/csv,.csv" />
                </span>&nbsp;
                <input type='text' id="idFileName" style='width:100%;' readonly />
            </div>
            <div class='col-2 text-right'>
                <button id='idBtnUpload0' class='btn btn-primary loading' style='width:100%;height:100%;'><i class="fas fa-upload"></i> Upload</button>
            </div>
        </div>
        <div class='row' style='height:90px;padding-top:40px;'>
            <div class='col-4'></div>
            <div class='col-4'>
                <h4 class="font-weight-bold text-center text-primary">Upload Test (from url)</h4>
            </div>
            <div class='col-4'></div>
        </div>
        <div class='row'>
            <div class='col-10'>
                <input type='text' id="idFileUrl" style='width:100%;' readonly />
            </div>
            <div class='col-2 text-right'>
                <button id='idBtnUpload1' class='btn btn-primary loading' style='width:100%;height:100%;'><i class="fas fa-upload"></i> Upload</button>
            </div>
        </div>
        <div class='row' style='height:90px;padding-top:40px;'>
            <div class='col-4'></div>
            <div class='col-4'>
                <h4 class="font-weight-bold text-center text-primary">IsRunning Test</h4>
            </div>
            <div class='col-4'></div>
        </div>
        <div class='row'>
            <div class='col text-center'>
                <input type='text' id="idTxtIsRunning" style='width:100%;' readonly />
            </div>
        </div>
        <div class='row' style='height:90px;padding-top:40px;'>
            <div class='col-4'></div>
            <div class='col-4'>
                <h4 class="font-weight-bold text-center text-primary">Loading Test</h4>
            </div>
            <div class='col-4'></div>
        </div>
        <div class='row'>
            <div class='col text-center'>
                <button id='idBtnRun' class='btn btn-primary running step3' style='width:200px;height:50px;'><i class="fab fa-deezer"></i> Run</button>
            </div>
        </div>
        <div class='row'>
            <div class='col'>
                <div id='idDivPerform' class='text-center' style='width:100%;height:200px;'></div>
            </div>
        </div>

    </div>

<script type="text/javascript">

    var url = "http://164.125.37.214:8000/";
    //var url = "http://93f0-218-51-166-84.ngrok.io/";
    let sKey = '';

    $(document).ready(function()
    {
        $.ajax(
        {
            url: url + "Fairness/getkey/",
            type: 'POST',
            dataType: 'JSON',
            success: function(res)
            {
                var res = JSON.parse(res);
                if ( res.success == 'true' )
                {
                    sKey = res.key;
                }
            }
        })
        
        var sFileName = '';

        var objFile = null;
        var handleFileSelect = function(e)
        {
            if ( !e.target.files ) return;
            
            objFile = e.target.files[0];

            $("#idFileName").val(objFile.name);
        }
        $("#fileupload")[0].addEventListener('change', handleFileSelect, false);

        $('#idBtnUpload0').on('click', function()
        {
            $('#idFileName').val('');
            $('#fileupload').val('');
            
            if ( objFile != null )
            {
                let formData = new FormData();
                formData.append('file', objFile);
                formData.append('key', sKey);
                $.ajax(
                {
                    url: url + "Fairness/upload/",
                    type: 'POST',
                    data: formData,
                    processData: false,
                    contentType: false,
                    success: function(res)
                    {
                        var res = JSON.parse(res);
                        if ( res.success == 'true' )
                        {
                            sFileName = res.filename;

                            $('#idFileName').val('');
                            $('#fileupload').val('');
                        }
                    }
                })
            }
            else
            {
                alert("Train 파일이 지정되지 않았습니다.");
                return;
            }
        });

        $('#idFileUrl').val('http://164.125.37.222:18099/data/201008/201008_origin_122219624.csv');
        
        $('#idBtnUpload1').on('click', function()
        {
            var sUrl = $('#idFileUrl').val()
            if ( sUrl != '' )
            {
                $.ajax(
                {
                    url: url + "Fairness/upload/",
                    type: 'POST',
                    data: JSON.stringify({'url': sUrl}),
                    dataType: 'JSON',
                    success: async function(res)
                    {
                        var res = JSON.parse(res);
                        if ( res.success == 'true' )
                        {
                            sFileName = res.filename;
                        }
                    }
                })
            }
            else
            {
                alert("Train 파일이 지정되지 않았습니다.");
                return;
            }
        });

        $('#idBtnRun').on('click', function()
        {
            if ( sFileName != '' )
            {
                $.ajax(
                {
                    url: url + "Fairness/run/",
                    type: 'POST',
                    data: JSON.stringify({'key': sKey, 'filename': sFileName}),
                    dataType: 'JSON',
                    success: function(res)
                    {
                        var res = JSON.parse(res);
                        if ( res.success == 'true' )
                        {
                            $.ajax(
                            {
                                url: url + "Fairness/getresult/",
                                type: 'POST',
                                data: JSON.stringify({'key': sKey}),
                                dataType: 'JSON',
                                success: function(res)
                                {
                                    var res = JSON.parse(res);
                                    var nPercentage = res.result.rate * 100.0;
                                    var sTag = '<p style="font-size:48px;">보정 성능 : ' + nPercentage.toFixed(3) + ' % ' + '</p>';
                                    $('#idDivPerform').html(sTag);
                                }
                            })
                        }
                    }
                })
            }
            else
            {
                alert("업로드 파일이 없습니다.");
                return;
            }
        });
    
        fnIsRunning();
        var id = window.setTimeout(function() {}, 0);
        while (id--)
        {
            window.clearTimeout(id);
        }
        varTimer = setInterval(fnIsRunning, 10000);
    });
    function fnIsRunning()
    {
        $.ajax(
        {
            url: url + "Fairness/isrunning/",
            type: 'POST',
            data: JSON.stringify({'key': sKey}),
            dataType: 'JSON',
            success: function(res)
            {
                var res = JSON.parse(res);
                var str = (res.running == 'true') ? 'run' : 'idle';
                $('#idTxtIsRunning').val(str);
                return res.running;
            }
        })
    }
</script>

</body>

</html>